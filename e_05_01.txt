実施テキスト：達人に学ぶDB設計徹底指南書

実施者：玉利仁美
実施日：12月1日

[演習5－1] 正規化されたテーブルに対するSQL

[演習内容]
 この演習で利用するテーブルは第３章の演習問題の解答を含むため、未解答の方はまず先に演習３-３に取り組んでください。
 さて、この演習では、演習3-3で正規化した以下の五つのテーブルについて考えます。
 (xxxx.png参照)
 上記五つのテーブルから、以下の要件を満たす結果を得るためのSQL文を考えてください。なお、テーブル名、列名、データの値は上記のテーブルのものを使用するものとします。
 SQL文①：商品分類ごとの商品数。結果には分類名を含むものとする。
 SQL文②：支社/支店別の取り扱い商品の一覧。結果には支社名、支店名、商品名を含むものとする。
 SQL文③：最も取り扱い商品数が多い支店の支店コードと商品数。
 

回答
SQL①
   
   SELECT                                                          -- 商品分類名と分類ごとの商品数を取り出すために列を指定する
        商品分類.分類名,                                           -- 分類名ごとの商品数を書くために名前を書き出す
        COUNT(商品.商品分類コード) AS 商品数                       -- 商品数として商品テーブルの商品分類コードごとにまとめてその個数を数える
   FROM                                                            -- 上記情報を取り出すための場所を指定する
        商品 LEFT OUTER JOIN 商品分類                              -- 一つのテーブルだけでは情報が不足しているため左記テーブルを結合する
   ON                                                              -- 一つのテーブルにまとめるためのキーを指定する
        商品分類.商品分類コード = 商品.商品分類コード              -- 商品分類コードは二つのテーブルで共通なのでその値で結合する
   GROUP BY                                                        -- 商品数を求めるため、どのカラムでまとめるのか指定する
        商品.商品分類コード                                        -- 各商品分類コードの商品数を求めるため商品分類コードでまとめる
   ;                                                               -- 命令文を終了させる

SQL②
   
   SELECT                                                          -- 支社支店別の取り扱い商品の一覧を表示するために表示するテーブルを選択する
         支店商品テーブル.*                                        -- 支店商品の取り扱い商品を名前を含めて表示するためすべてのカラムを取り出す
   FROM                                                            -- どこのテーブルから取り出すのか求める情報をもつテーブルを指定する
         ((                                                        -- ４つのテーブルからデータを取り出すため結合を行うのでわかりやすくするためカッコでくくる
         支店商品 INNER JOIN 支社                                  -- 支社テーブルにある支社名のデータが欲しいので内部結合を行う
          ON                                                       -- 支社テーブル内にある情報をとるために結合のキーを指定する
         支店商品.支社コード = 支社.支社コード                     -- 支社コードは共通の値なのでその値で結合を行う
         ) INNER JOIN 支店                                         -- 次に支店名が欲しいので支社と同様に支店テーブルと結合を行う
         ON                                                        -- 支店テーブル内にある情報をとるために結合のキーを指定する
         支店商品.支社コード = 支店.支社コード                     -- まず支社コードによる結合を行う
         AND                                                       -- 支社コードだけではほしいデータを絞り切れないので条件を追加する
         支店商品.支店コード = 支店.支店コード                     -- 支社コードが一致していてかつ支店コードが一致しているデータが欲しい情報なので支店コードでも結合を行う
         ) INNER JOIN 商品                                         -- 最後に商品名を取り出したいので同様に内部結合を行う
         ON                                                        -- 商品名を取り出すためのキーを指定する
         支店商品.商品コード = 商品.商品コード                     -- 商品コードが二つのテーブルで一致しているのでそれをキーにし、結合を行う
   ;                                                               -- 命令文を終了させる

SQL③

   SELECT                                                          -- 最も取り扱い商品数が多い支店の支社コード、支店コード、商品数を取り出すために取り出す値を指定する
        商品数サブクエリ.支社コード,                               -- 支店コードのみではどこの支社のものなのかわからないので、支社コードを取り出す
        商品数サブクエリ.支店コード,                               -- 支店コードごとの商品数が欲しいので支店コードを取り出す
        商品数サブクエリ.商品数                                    -- 支社・支店コードごとの商品数を取り出す
   FROM                                                            -- 上記の情報を持っている場所を指定する
        (SELECT                                                    -- 各店舗の商品数を求めるためサブクエリを作成する
               支社コード,                                         -- 最終的に支社コードを取り出すために支社コードを取り出しておく
               支店コード,                                         -- 最終的に支店コードを取り出すために支店コードを取り出しておく
               COUNT(*)                                            -- 商品数を求めるため支社コード・支店コードごとにカウントする
         FROM                                                      -- 上記情報を取り出すため上記データを持っているテーブルを指定する
               支店商品テーブル                                    -- 上記情報を持っているのは支店商品テーブルなので指定する
         GROUP BY                                                  -- どの値によってカウントするのかを指定する
               支社コード,                                         -- 支社コード・支店コード二つの値ごとにカウントを行うためにカウントする
               支店コード                                          -- 支社コード・支店コード二つの値ごとにカウントを行うためにカウントする
         ) AS 商品数サブクエリ                                     -- 取り出すときに指定しやすいよう別名を設ける
   WHERE                                                           -- ほしい情報は最大取扱数の店舗なので取り出す情報に制限を設ける
        商品数サブクエリ.商品数 IN                                 -- 商品数が以下の条件に合うものだけを取り出す
        (                                                          -- 取り出す条件の比べるデータをくくるためのカッコ
         SELECT                                                    -- 最大取扱商品数を取り出すためのサブクエリを作成する
               MAX(商品数サブクエリ.商品数)                        -- カウントで出た商品数の中の最大値を求め最大商品数が何個か求める
         FROM                                                      -- 上記データを持っている場所を指定する
               (                                                   -- 商品数を求めるサブクエリをくくるカッコ
               SELECT                                              -- 各店舗の商品数を求めるためサブクエリを作成する
                     支社コード,                                   -- 最終的に支社コードを取り出すために支社コードを取り出しておく
                     支店コード,                                   -- 最終的に支店コードを取り出すために支店コードを取り出しておく
                     COUNT(*)                                      -- 商品数を求めるため支社コード・支店コードごとにカウントする
               FROM                                                -- 上記情報を取り出すため上記データを持っているテーブルを指定する
                     支店商品テーブル                              -- 上記情報を持っているのは支店商品テーブルなので指定する
               GROUP BY                                            -- どの値によってカウントするのかを指定する
                     支社コード,                                   -- 支社コード・支店コード二つの値ごとにカウントを行うためにカウントする
                     支店コード                                    -- 支社コード・支店コード二つの値ごとにカウントを行うためにカウントする
              ) AS 商品数サブクエリ                                -- 取り出すときに指定しやすいよう別名を設ける
         )                                                         -- 取り出す条件の比べるデータをくくるためのカッコ
    ;                                                              -- 命令文を終わらせる
   
備考：問題では支店コードと商品数を取り出すような問題になっていますが、支店コードは支社コードごとに番号を付けているため、支店コードのみの特定はできない。そのため、支店コードのみではなく支社コードも取り出し結果に表示させました。(佐藤さん了承済み)

参考資料：


